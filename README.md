# 📦 معماری دقیق رمزنیوز نسل ۲ (RamzNews Gen 2)

نسخه کاملاً بازطراحی‌شده برای یک سیستم هوشمند، دقیق و پایدار تولید و توزیع محتوای خبری در تلگرام، با تمرکز بر کیفیت، عملکرد، و رضایت مخاطب نهایی.

---

## 🔑 پیکربندی هاردکد شده

در این نسخه از پروژه، به جای استفاده از متغیرهای محیطی (environment variables)، تمامی تنظیمات در فایل `config.js` به صورت هاردکد ذخیره شده‌اند. این رویکرد مزایای زیر را دارد:

* **سادگی استقرار**: نیازی به تنظیم متغیرهای محیطی در سرور نیست
* **قابلیت ردیابی تغییرات**: تغییرات تنظیمات در سیستم کنترل نسخه قابل ردیابی هستند
* **سازگاری بیشتر**: مشکلات مرتبط با فراموش کردن تنظیم متغیرهای محیطی را ندارد
* **تست آسان‌تر**: تمام تنظیمات در یک فایل متمرکز هستند

این تنظیمات شامل موارد زیر می‌شوند:
* 🤖 توکن و تنظیمات ربات تلگرام
* 🧠 کلید API و تنظیمات هوش مصنوعی (OpenRouter)
* 📰 لیست فیدهای RSS
* 💾 تنظیمات ذخیره‌سازی
* 🔄 تنظیمات پردازش
* 📝 قالب پرامپت هوش مصنوعی

برای تغییر هر یک از این تنظیمات، کافی است فایل `config.js` را ویرایش کنید.

---

## 🎯 اهداف کلیدی پروژه

* تولید **محتوای خبری تمیز، خلاصه، دقیق، ساختارمند و موبایل‌پسند** برای تلگرام
* استفاده از **مدل‌های زبان هوشمند (LLMs)** جهت افزایش کیفیت محتوا
* پشتیبانی از **ساختارهای متنوع محتوایی**: متن، هشتگ، تصویر، منبع، بولت لیست
* تضمین ارسال یکتا و به‌موقع بدون تکرار و بیات شدن پست
* زیرساخت **کاملاً رایگان یا کم‌هزینه** با استفاده از Cloudflare Workers، KV، D1 و OpenRouter
* طراحی قابل نگهداری و توسعه‌پذیر برای جلوگیری از فروپاشی آینده

---

## 🧱 اجزای معماری سیستم

### 1. 📰 `fetchFeeds.js`

**وظیفه:** استخراج اخبار از منابع RSS ثبت‌شده.

#### مشخصات:

* دریافت RSS از منابع مختلف (BBC، DW، یورونیوز، رمزارز نیوز، ارز دیجیتال،...)
* استخراج اطلاعات کلیدی: `title`, `link`, `description`, `pubDate`, `source`
* ذخیره در صف KV برای پردازش بعدی
* تشخیص ساختار فید (RSS یا Atom)
* کرون: اجرای هر 5 الی 10 دقیقه با Cron Trigger کلادفلر

#### مسیر آینده:

* تشخیص خودکار فیدهای معیوب و گزارش خطا به تیم

---

### 2. 🧠 `aiFormatter.js`

**وظیفه:** تبدیل داده خام به یک پست بهینه‌شده برای تلگرام با کمک LLM

#### ورودی:

```json
{
  "title": "عنوان خبر",
  "description": "شرح کامل یا بخشی از خبر",
  "source": "BBC Persian",
  "link": "https://example.com/article"
}
```

#### خروجی:

```json
{
  "telegram_text": "📌 <b>عنوان خلاصه</b>\n\n• نکته ۱\n• نکته ۲\n\n<i>منبع: BBC Persian</i>",
  "image_url": "https://example.com/image.jpg",
  "hashtags": ["#بیت_کوین", "#اقتصاد"],
  "summary": "متن خلاصه شده ۳-۵ خطی"
}
```

#### ویژگی‌ها:

* خلاصه‌سازی حرفه‌ای بدون افت معنا
* حذف تبلیغات، لینک‌های زائد و جداول خراب
* تشخیص خودکار دسته‌بندی محتوا برای ایموجی و هشتگ
* استخراج تصویر (از `og:image`, `twitter:image`, یا `<img>` در HTML)

#### پرامپت پیشنهادی OpenRouter:

```
یک خبر فارسی شامل عنوان و متن دارم. لطفاً آن را به یک پست تلگرامی خلاصه و زیبا تبدیل کن:
- حداکثر ۵ خط
- دارای لحن حرفه‌ای و خبری
- موبایل‌پسند، دارای ایموجی و هشتگ فارسی
- اگر تصویر دارد، فقط لینک تصویر را خروجی بده
- فقط فارسی بنویس، بدون جداول، تبلیغ یا جمله ناقص
ورودی:
عنوان: {title}
متن: {description}
```

---

### 3. 📤 `sendTelegram.js`

**وظیفه:** ارسال پست فرمت‌شده به کانال تلگرام + بررسی تکراری بودن

#### جزئیات:

* استفاده از Bot Token و Telegram Bot API
* ارسال متن با `parse_mode: HTML`
* افزودن تصویر با `sendPhoto` اگر `image_url` وجود داشت
* امضای انتهایی کانال

#### بررسی یکتایی:

* با استفاده از `generatePostIdentifier()` یک شناسه یکتا تولید می‌شود
* مقایسه با KV/D1 قبل از ارسال
* اگر تکراری باشد، از ارسال صرف‌نظر می‌شود

---

### 4. 🗃 `KV / D1` برای ذخیره وضعیت

#### KV (ساده‌تر و سریع‌تر):

* کلید: `postId` یا `title_hash`
* مقدار: `sentAt`, `source`, `contentHash`
* TTL: 30 روز

#### D1 (اگر تحلیل و جستجو نیاز شد):

* جدول `posts`

  * `id`, `hash`, `source`, `title`, `created_at`, `image_url`, `category`

---

### 5. ⏰ Cron Triggers

* `fetchFeeds.js`: هر 10 دقیقه
* `aiFormatter.js`: هر 1 دقیقه برای صف‌های جدید
* `sendTelegram.js`: هر 1 دقیقه

---

## 🌐 محیط‌های توسعه و اجرای پایدار

### Cloudflare Workers

* رایگان تا 100,000 درخواست ماهانه
* نصب ساده با Wrangler CLI (`wrangler init`, `wrangler dev`, `wrangler deploy`)
* تعریف Secretها: `wrangler secret put TELEGRAM_TOKEN`

### Cloudflare KV / D1

* تعریف binding در `wrangler.toml`

```toml
[[kv_namespaces]]
binding = "POST_TRACKER"
id = "xxxxxxx"
```

### OpenRouter.ai

* ثبت‌نام رایگان
* گرفتن `API_KEY`
* مدل پیشنهادی: `mistralai/mixtral-8x7b`, `claude-instant`, `nous-capybara`
* ارسال درخواست‌ها با `fetch` + هدر `Authorization: Bearer {key}`

### Telegram

* ساخت Bot از طریق BotFather
* گرفتن `TOKEN`
* تعریف `CHANNEL_USERNAME`

---

## 🧱 ساختار پیشنهادی پوشه پروژه

```
/ramznews-gen2
├── fetchFeeds.js
├── aiFormatter.js
├── sendTelegram.js
├── config.js
├── shared/
│   ├── sanitize.js
│   ├── identifier.js
│   └── category.js
├── wrangler.toml
└── README.md
```

---

## ✅ راهبردهای توسعه‌ای حیاتی برای ایجنت

1. **کدنویسی ماژولار:** هر فایل یک وظیفه، هیچ تابع تودرتوی بی‌هدف
2. **پرونده‌ها ساده و قابل‌تست:** هر کد باید تست‌پذیر باشد (با داده RSS تستی)
3. **استفاده از لاگ معنادار:** هر مرحله لاگ استاندارد و قابل‌جستجو
4. **اجتناب از فیلترهای غیردینامیک:** بجای `if` های زیاد، پردازش مبتنی بر context و دسته‌بندی AI
5. **هندلینگ خطا کامل:** هیچ خطایی نباید باعث متوقف شدن کل فرآیند شود
6. **تست با چند سناریو فید:** فید خبری، رمزارز، اقتصادی، طولانی، بی‌تصویر، خراب، تبلیغاتی، ویدئویی
7. **مستندسازی دقیق همه ورودی/خروجی‌ها**
8. **جداسازی داده‌ها از منطق:** همه `FEED_LIST`, `TOKEN`, `PROMPT_TEMPLATE` در فایل مستقل قابل تغییر باشد
9. **استفاده حداکثری از امکانات رایگان**
10. **هر ماژول مستقل قابل استقرار و دیباگ باشد**

---

# 🧾 راهنمای ساختار، زیباسازی و اصول تولید پست‌های تلگرام در پروژه رمزنیوز نسل ۲

این سند به‌طور تخصصی به اصول **فرمت، ساختار، محتوا، و زیباسازی پست‌های تلگرامی** در پروژه رمزنیوز می‌پردازد. هدف، تولید پست‌هایی است که:

* 📱 کاملاً موبایل‌پسند و قابل‌خواندن باشند
* 🎨 زیبایی بصری و نظم داشته باشند
* 🧠 محتوا را به‌صورت دقیق، مختصر و حرفه‌ای منتقل کنند
* 📸 تصویر جذاب داشته باشند (در صورت وجود)
* ⚠️ هیچ لینک یا نشانی خارجی نداشته باشند و منبع محتوا **خود کانال** تلقی شود

---

## 📐 ساختار نهایی پست تلگرامی

```html
📌 <b>عنوان خلاصه‌شده</b>

• نکته اول یا خط اول از متن خلاصه‌شده
• نکته دوم یا خط دوم
• نکته سوم...

#رمزارز #بیت_کوین #اقتصاد
@ramznewsofficial | اخبار رمزی
```

---

## 📦 اجزای الزامی هر پست

| بخش            | توضیح                              | الزامی؟          |
| -------------- | ---------------------------------- | ---------------- |
| 🎯 عنوان       | خلاصه‌شده، واضح، بدون تکرار متن    | ✅                |
| 📄 متن         | خلاصه‌شده ۳-۵ خط، بولت‌دار، منظم   | ✅                |
| 📸 تصویر       | استخراج از og\:image یا لینک معتبر | ✅ (در صورت وجود) |
| 🏷 هشتگ        | ۲ تا ۵ تا، موضوعی و هدفمند         | ✅                |
| 🖋 امضای کانال | برندینگ نهایی                      | ✅                |
| 🔗 لینک منبع   | ❌ حذف کامل لینک‌های خارجی          |                  |

---

## ✨ اصول زیباسازی پست‌ها

1. **عنوان** با `<b>` بولد شود
2. بین پاراگراف‌ها و خطوط، `\n\n` یا `\n` رعایت شود
3. محتوای خبری به‌صورت **بولت لیست** (`•`) ارائه شود
4. **از ایموجی مرتبط** در عنوان یا خطوط استفاده شود:

   * رمزارز: 💰، 📉، 📈
   * فوری: ⚡️، 🚨
   * سیاسی: 🏛، 🗳
   * خبری عمومی: 🔴، 📌
5. **هیچ لینکی به سایت، مقاله یا منبع خارجی نباید درج شود**
6. تصویر در صورت وجود، با `sendPhoto` ارسال شود

---

## 📸 تصویر در پست

> تصویر، عنصری حیاتی برای جلب توجه کاربر موبایل است.

### مراحل تهیه تصویر:

1. بررسی `og:image` در `<meta property="og:image">`
2. بررسی `twitter:image` یا `<img class="featured">`
3. اگر نسبتی بالای 4:3 یا 16:9 نداشت، استفاده نشود
4. اگر تصویر یافت نشد، پست فقط متنی ارسال شود ولی لاگ زده شود

### نکات:

* فرمت مناسب: `.jpg`، `.png`
* حجم کمتر از 2MB
* ارسال با `caption` برابر همان متن پست

---

## 🧠 چک‌لیست قبل از ارسال پست

* [x] عنوان واضح و غیرتکراری
* [x] متن خلاصه با بولت‌ها
* [x] حذف تبلیغات، لینک‌های زائد، جداول شکسته
* [x] حذف عنوان تکراری از متن
* [x] تصویر مرتبط پیدا و الصاق شده (در صورت وجود)
* [x] بدون هیچ لینک خارجی یا منبع سایت
* [x] هشتگ‌ها مرتبط و محدود به ۵ عدد

---

## 🛑 نبایدها

* ارسال پست بدون عنوان یا متن
* استفاده از متن با بیش از ۷ خط
* ارسال پست با لینک خام یا حتی لینک با anchor فارسی به منبع
* استفاده از متن خام HTML سایت (با تگ‌های باقی‌مانده)
* گذاشتن تصویر بی‌ربط یا تبلیغاتی

---

## 🚨 نکات مهم برای تیم توسعه

* **اولویت همیشه کیفیت پست است نه کمیت**؛ اگر پستی ناقص بود ارسال نشود
* **ساختار بالا باید در خروجی AI رعایت شود**
* **هرگونه اشاره به منبع اصلی خبر، لینک، نام سایت، یا عبارت "مشاهده بیشتر" ممنوع است**
* اگر تصویر وجود نداشت، پست بدون آن ولی تمیز و زیبا ارسال شود
* اگر AI خروجی خوبی نداد، لاگ شود برای بهبود پرامپت‌ها

---

## 📍 نمونه واقعی پست ایده‌آل (بدون منبع خارجی):

```
💰 <b>قیمت بیت‌کوین از ۷۰ هزار دلار عبور کرد</b>

• بیت‌کوین امروز سقف تاریخی جدیدی ثبت کرد
• کارشناسان صعودی بودن بازار را پیش‌بینی می‌کنند
• احتمال اصلاح قیمت در روزهای آینده وجود دارد

#بیت_کوین #رمزارز #بازار #تحلیل
@ramznewsofficial | اخبار رمزی
```

---

## 🧠 نقشه توسعه آتی (نسخه ۲.۵+)

* استخراج عنوان تصویری از HTML و ساخت کاور برای پست
* ساخت پست‌های تصویری با دکمه «ادامه در سایت»
* ارسال آفلاین در صورتی که API تلگرام موقتاً داون شد (با صف زمان‌دار)
* سیستم گزارش روزانه لاگ و وضعیت ارسال‌ها
* داشبورد Cloudflare Pages برای مشاهده پست‌های منتشرشده 